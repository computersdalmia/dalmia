name: JANU Quality Gate

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y shellcheck

      - name: ShellCheck repo scripts
        run: |
          set -e
          # shellcheck only repo scripts; server paths not present in CI
          if ls **/*.sh >/dev/null 2>&1; then
            shellcheck -x **/*.sh || true
          fi

      - name: Block pasted HTML tags inside repo shell scripts
        run: |
          set -e
          bad=$(grep -RInE "^[[:space:]]*<(script|link|div|li|style|html|head|body)\b" --include="*.sh" . || true)
          if [ -n "$bad" ]; then
            echo "$bad"
            exit 1
          fi

      - name: Basic bash syntax (repo)
        run: |
          set -e
          shopt -s globstar nullglob
          for f in **/*.sh; do
            bash -n "$f"
          done
